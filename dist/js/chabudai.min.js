"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}(function($){var all=function all(array,type){if(!array.length){return false}return array.reduce(function(acc,cur){return acc&&(typeof cur==="undefined"?"undefined":_typeof(cur))===type},true)};$.fn.table=function(config){config=config||{};if(config==="selected"){var $table=this;var selected=$table[0].querySelectorAll("colgroup .selected");if(!selected.length){return[]}var indeces={};Array.prototype.forEach.call(selected,function(el){indeces[el.dataset.variable]=Array.prototype.indexOf.call($table[0].querySelectorAll("colgroup col"),el)});return Array.prototype.map.call($table[0].querySelectorAll("tbody tr:not([aria-hidden])"),function(tr){var o={};Object.keys(indeces).forEach(function(k){o[k]=tr.querySelector("td:nth-child("+(indeces[k]+1)+")").firstChild.value});return o})}if(!(config.data&&config.data.length)){return}var options=$.extend(true,{"headers":config.data&&config.data.length?Object.keys(config.data[0]):[],"paginate":10,"responsive":false,"editable":false,"filled":true,"nav":{"items":5,"prev":"&lang;","next":"&rang;","align":"center"}},this[0].dataset,config);options.navItems=options.navItems||options.nav.items;options.navPrev=options.navPrev||options.nav.prev;options.navNext=options.navNext||options.nav.next;options.navAlign=options.navAlign||options.nav.align;if(!Array.isArray(options.editable)){if(options.editable==="true"||options.editable===true){options.editable=options.headers}else{options.editable=[]}}options.data=options.data||[];var $plugin=void 0;var $nav=void 0;var editing=void 0;var keycode={ENTER:13};if(this[0].tagName.match(/table/i)){$plugin=this}else{$plugin=$("<table>",{"class":options["class"]});this.append($plugin)}$plugin[0].classList.add("table-chabudai");$plugin.empty();if($plugin[0].nextElementSibling&&$plugin[0].nextElementSibling.tagName.match(/nav/i)&&$plugin[0].nextElementSibling.firstChild&&$plugin[0].nextElementSibling.firstChild.classList.contains("pagination")){$plugin[0].parentNode.removeChild($plugin[0].nextElementSibling)}else if($plugin[0].parentNode.classList.contains("table-responsive")&&$plugin[0].parentNode.nextElementSibling.tagName.match(/nav/i)){$plugin[0].parentNode.parentNode.removeChild($plugin[0].parentNode.nextElementSibling)}$plugin.append($("<colgroup>").append(["#"].concat(_toConsumableArray(options.headers)).map(function(h){return $("<col>",{"span":1,"data-variable":h,"data-disabled":options.editable.indexOf(h)===-1?"true":"false"})})));$plugin.append($("<thead>").append($("<tr>").append(["#"].concat(_toConsumableArray(options.headers)).map(function(x){return $("<th scope=\"col\">"+x+"</th>")}))));$plugin.append($("<tbody>").append(options.data.map(function(row,index){return $("<tr>").append($("<th>",{scope:"row"}).html(index+1),Object.keys(row).map(function(key){var value=row[key];var disable=options.editable.indexOf(key)===-1;if(Array.isArray(value)){if(value.length===0){return $("<td><input type=\"text\" value=\"\" "+(disable?"disabled":"")+"></td>")}var choices=value.map(function(v){return"<option value=\""+v+"\">"+v+"</option>"}).join("");return $("<td><select class=\"custom-select\" "+(disable?"disabled":"")+">"+choices+"</select></td>")}else{return $("<td><input type=\"text\" value=\""+value+"\" "+(disable?"disabled":"")+"></td>")}}))})));if(options.filled&&options.data.length%options.paginate!=0){var fillers=Array(options.paginate-options.data.length%options.paginate);for(var i=0;i<fillers.length;i++){fillers[i]=$("<tr aria-hidden><th>&nbsp;</th></tr>")}$plugin.find("tbody").append(fillers)}var stopEditing=function stopEditing(){if(!editing){return}if(editing.tagName.match(/td/i)){editing.classList.remove("editing");editing.firstChild.blur()}else if(editing.tagName.match(/tr/i)){var input=editing.querySelector("td textarea");var values=JSON.parse(input.value);editing.removeChild(input.parentNode);Object.keys(values).forEach(function(key){var index=Array.prototype.indexOf.call($plugin[0].querySelectorAll("col"),$plugin[0].querySelector("col[data-variable=\""+key+"\"]"));editing.children[index].firstChild.value=values[key]});Array.prototype.forEach.call(editing.getElementsByTagName("td"),function(td){return td.style=null});editing.classList.remove("editing")}$plugin.trigger($.Event("chabudai:edited",{"target":editing}));editing=null};var startEditing=function startEditing(el){if(editing){return}if(el.tagName.match(/td/i)){var index=Array.prototype.indexOf.call(el.parentNode.children,el);if($plugin[0].querySelector("col:nth-child("+(index+1)+")").dataset.disabled==="true"){return}editing=el}else if(el.tagName.match(/th/i)){var cells=el.parentNode.getElementsByTagName("td");var values=Array.prototype.map.call(cells,function(el){return el.firstChild.value});var headers=Array.prototype.filter.call($plugin[0].querySelectorAll("thead th[scope=\"col\"]"),function(el){return $plugin[0].querySelector("col[data-variable=\""+el.innerHTML+"\"]").dataset.disabled==="false"});if(!headers.length){return}var map={};headers.map(function(el){return el.innerHTML}).forEach(function(h,i){return map[h]=values[i]});editing=el.parentNode;Array.prototype.forEach.call(cells,function(el){return el.style.display="none"});$(editing.firstChild).after($("<td>",{"class":"editing","colspan":cells.length}).append($("<textarea>",{"rows":headers.length+2}).val(JSON.stringify(map,null,2))));var textarea=editing.querySelector("td textarea");textarea.focus();textarea.selectionStart=textarea.selectionEnd=textarea.value.length}editing.classList.add("editing");$plugin.trigger($.Event("chabudai:edit",{"target":el}))};var clickInside=function clickInside(e){if($plugin[0].contains(e.target)){$plugin[0].removeEventListener("click",clickInside);document.addEventListener("click",clickOutside)}};var clickOutside=function clickOutside(e){if(!$plugin[0].contains(e.target)){stopEditing();document.removeEventListener("click",clickOutside);$plugin[0].addEventListener("click",clickInside)}};$plugin[0].addEventListener("click",clickInside);$plugin.on("click","td:not(.editing)",function(e){stopEditing();startEditing(this)});$plugin.on("click","th[scope=\"row\"]",function(e){if(!this.parentNode.classList.contains("editing")){stopEditing();startEditing(this)}});$plugin.on("keypress","td.editing",function(e){if(e.which==keycode.ENTER){stopEditing()}});$plugin.on("click","th[scope=\"col\"]:first-child",function(e){stopEditing()});$plugin.on("click","th[scope=\"col\"]:not(:first-child)",function(e){stopEditing();$plugin[0].querySelector("colgroup col[data-variable=\""+this.innerHTML+"\"]").classList.toggle("selected");$plugin.trigger($.Event("chabudai:select",{"target":this}))});var pageTo=function pageTo(li){if($nav===null){return}var active=$nav[0].querySelector(".active");if(active){active.classList.remove("active")}li.classList.add("active");var page=li.dataset.page;var rows=$plugin[0].tBodies[0].rows;for(var _i=0;_i<rows.length;_i++){rows[_i].style.display="none"}for(var _i2=(page-1)*options.paginate;_i2<rows.length&&_i2<page*options.paginate;_i2++){rows[_i2].style.display=null}};var navNext=function navNext(){$nav[0].querySelector("li:first-child").classList.remove("disabled");var items=$nav[0].querySelectorAll("li:not(:first-child):not(:last-child)");var i=0;var n=0;while(items[i].classList.contains("d-none")){i++}while(i<items.length-options.navItems&&n<options.navItems){items[i].classList.add("d-none");n++;i++}n=0;while(i<items.length&&n<options.navItems){items[i].classList.remove("d-none");n++;i++}if(!items[items.length-1].classList.contains("d-none")){$nav[0].querySelector("li:last-child").classList.add("disabled")}};var navPrev=function navPrev(){$nav[0].querySelector("li:last-child").classList.remove("disabled");var items=$nav[0].querySelectorAll("li:not(:first-child):not(:last-child)");var i=items.length-1;var n=0;while(items[i].classList.contains("d-none")){i--}while(i>=options.navItems&&n<options.navItems){items[i].classList.add("d-none");n++;i--}n=0;while(i>=0&&n<options.navItems){items[i].classList.remove("d-none");n++;i--}if(!items[0].classList.contains("d-none")){$nav[0].querySelector("li:first-child").classList.add("disabled")}};if(options.data.length>10&&options.paginate!==false){var total=Math.ceil(options.data.length/10);var items=[];for(var _i3=0;_i3<total;_i3++){items[_i3]=$("<li class=\"page-item\" data-page=\""+(_i3+1)+"\"><a class=\"page-link\">"+(_i3+1)+"</a></li>")}$nav=$("<nav>");if(items.length>options.navItems){for(var j=options.navItems;j<items.length;j++){items[j][0].classList.add("d-none")}items.unshift($("<li class=\"page-item disabled\"><a class=\"page-link\">"+options.navPrev+"</a></li>"));items.push($("<li class=\"page-item\"><a class=\"page-link\">"+options.navNext+"</a></li>"));$nav.on("click","li:first-child:not(.disabled)",function(e){navPrev()});$nav.on("click","li:last-child:not(.disabled)",function(e){navNext()})}$nav.append($("<ul>",{"class":"pagination justify-content-center"}).append(items));$nav.on("click","li[data-page]:not(.active)",function(e){e.preventDefault();pageTo(this)});$plugin.after($nav);pageTo($nav[0].querySelector("li[data-page=\"1\"]"))}if(options.responsive){$plugin.wrap("<div class=\"table-responsive\"></div>")}else if($plugin[0].parentNode.classList.contains("table-responsive")){$plugin.unwrap()}return $plugin}})(jQuery);
